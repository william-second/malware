# -*- coding: utf-8 -*-
"""
24 Aug 2016
A script to find all information about specific malware
given the analysis ID in malwr.com or MD5 hash
"""

# Import statements
from __future__ import print_function
#import pymongo
import json
import gzip
import os
import glob  

class MalwrReader(object):
    def __init__(self,
                 malware_data_path='/home/quyen/Desktop/T3_Data/malware_data',
                 malware_full_log_path='/home/quyen/Desktop/T3_Data/malware_full_log',
                 mongo_host=None,
                 mongo_port=None):
        self.malware_data_path = malware_data_path
        self.malware_full_log_path = malware_full_log_path
        #self.mongo_host = mongo_host
        #self.mongo_port = mongo_port
        #self.mongo_server = pymongo.MongoClient(host=mongo_host, port=mongo_port)
        #self.mongo_db = self.mongo_server['malware_crawler']
        #self.mongo_coll = self.mongo_db['malware']

    def get_by_md5_hash(self, md5_hash):
        '''Returns a list of malware objects from its MD5 hash

        Note that this might return more than one malware, since it is possible
        for two malware to have the same MD5 hash
        '''
        result = []
        for malware in self.mongo_coll.find({'md5_hash':md5_hash}):
            url = malware['url']
            analysis_id = url.split('/')[-2]
            one_malware = self.get_by_analysis_id(analysis_id)
            result.append(one_malware)
        return result
    
    def get_by_analysis_id(self, analysis_id):
        '''Returns malware object from its analysis ID

        The malware will be a dictionary with the following keys:
        - filetype - A string describing the file type
        - antivirus -  A dictionary of antivirus classification
        - https - A list of HTTP accesses
        - smtps - A list of SMTP accesses
        - ircs - A list of IRC accesses
        - hosts -  A list of hosts contacted (IP addresses)
        - domains - A list of domains contacted (domain names)
        - file_accesses - A list of file accessed
        - registry_keys - A list of registry keys accessed
        - dropped_files - A list of files dropped
        - signatures - A list of signatures, with the cause (if present)
        - processes - A list of processes
            Each process is a dictionary with the following keys:
            - process_name - A string of the process name
            - process_id - Process ID
            - parent_id - The parent ID spawning this process
            - first_seen - When this malware is first seen
            - calls - A list of API calls (without arguments)
            - full_log - A list of API calls (with arguments)
                         This might be empty if it has not been crawled yet
        '''
        try:
            data_path = '{}/{}'.format(self.malware_data_path, analysis_id)
            with gzip.open(data_path, 'r') as infile:
                one_malware = json.loads(infile.read().decode('utf-8'))
        except:
            exc = FileNotFoundError('No malware with path: {}'.format(data_path))
            exc.__cause__ = None
            raise exc
        if 'processes' in one_malware:
            processes = json.loads(one_malware['processes'])
            one_malware['processes'] = processes
            for process in processes:
                process_id = process['process_id']
                full_log_path = '{}/{}_{}'.format(self.malware_full_log_path, analysis_id, process_id)
                if os.path.exists(full_log_path):
                    with gzip.open(full_log_path, 'r') as infile:
                        full_log = json.loads(infile.read().decode('utf-8'))
                    full_log = json.loads(full_log['full_log'])
                else:
                    full_log = []
                process['full_log'] = full_log
         

        return one_malware


def main():
    # This is example usage of MalwrReader class
    reader = MalwrReader()
    from pprint import pprint
    # To get a malware by its analysis ID (the file names in malware_data directory)
    pprint(reader.get_by_analysis_id('M2E0MDE3Zjk0NTRhNGE5ZGIyM2Q2ZjM1M2ExY2EwMzY'))
    #pprint(reader.get_by_md5_hash('9ba89d32901bc5997107aece18905cb4'))
    malware_data_path='/home/quyen/Desktop/T3_Data/malware_data/*'
    #pprint glob.glob(malware_data_path)
    #import glob 
    #print glob.glob("/home/quyen/*")

if __name__ == '__main__':
    main()

